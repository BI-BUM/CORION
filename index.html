<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Badminton Match Scheduler</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f5;
  padding: 20px;
  text-align: center;
}
h1 {
  color: #2c3e50;
}
.controls {
  margin-bottom: 20px;
}
label { margin-right: 10px; }
input[type=range] { width: 150px; }
button { margin: 5px; padding: 5px 10px; }
#courts {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
}
.court {
  width: 180px;
  height: 100px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  transition: transform 0.1s;
}
.court:hover {
  transform: scale(1.05);
}
</style>
</head>
<body>
<h1>Badminton Match Scheduler</h1>

<div class="controls">
  <div>
    <label>人数: <span id="numPlayersVal">4</span></label>
    <input type="range" id="numPlayers" min="2" max="20" value="4">
  </div>
  <div>
    <label>コート数: <span id="numCourtsVal">2</span></label>
    <input type="range" id="numCourts" min="1" max="5" value="2">
  </div>
  <div>
    <label><input type="radio" name="mode" value="s" checked> シングルス</label>
    <label><input type="radio" name="mode" value="d"> ダブルス</label>
  </div>
  <div>
    <button id="generate">試合生成</button>
    <button id="joinPlayer">プレイヤー追加</button>
  </div>
</div>

<div id="courts"></div>

<script>
class Player {
  constructor(id){
    this.id=id;
    this.matches=0;
    this.last_played=-1;
  }
}

class Scheduler {
  constructor(numPlayers,numCourts,mode){
    this.players={};
    for(let i=1;i<=numPlayers;i++) this.players[i]=new Player(i);
    this.numCourts=numCourts;
    this.mode=mode;
    this.courts=new Array(numCourts).fill(null);
    this.round=0;
    this.vs_count={};
    this.pair_count={};
  }

  availablePlayers(){
    let busy=new Set();
    for(let m of this.courts){
      if(!m) continue;
      if(this.mode==='s'){ busy.add(m[0].id); busy.add(m[1].id); }
      else for(let p of [...m[0],...m[1]]) busy.add(p.id);
    }
    return Object.values(this.players).filter(p=>!busy.has(p.id));
  }

  pickSingles(){
    let cand=this.availablePlayers();
    if(cand.length<2) return null;
    cand.sort((a,b)=>a.matches-b.matches || a.last_played-b.last_played || a.id-b.id);
    let p1=cand[0]; cand.splice(0,1);
    cand.sort((a,b)=>{
      let keyA=this.vs_count[[p1.id,a.id].sort().join(',')]||0;
      let keyB=this.vs_count[[p1.id,b.id].sort().join(',')]||0;
      return keyA-keyB || a.matches-b.matches || a.last_played-b.last_played || a.id-b.id;
    });
    return [p1,cand[0]];
  }

  pickDoubles(){
    let cand=this.availablePlayers();
    if(cand.length<4) return null;
    let pairs=[];
    for(let i=0;i<cand.length;i++)
      for(let j=i+1;j<cand.length;j++) pairs.push([cand[i],cand[j]]);
    pairs.sort((a,b)=>{
      let keyA=this.pair_count[[a[0].id,a[1].id].sort().join(',')]||0;
      let keyB=this.pair_count[[b[0].id,b[1].id].sort().join(',')]||0;
      return keyA-keyB || (a[0].matches+a[1].matches)-(b[0].matches+b[1].matches);
    });
    for(let t1 of pairs){
      for(let t2 of pairs){
        let ids=new Set([t1[0].id,t1[1].id,t2[0].id,t2[1].id]);
        if(ids.size===4) return [t1,t2];
      }
    }
    return null;
  }

  newMatch(cid){
    this.round++;
    if(this.mode==='s'){
      let match=this.pickSingles();
      if(!match){ this.courts[cid]=null; return; }
      let [p1,p2]=match;
      [p1,p2].forEach(p=>{p.matches++; p.last_played=this.round;});
      this.vs_count[[p1.id,p2.id].sort().join(',')] = (this.vs_count[[p1.id,p2.id].sort().join(',')]||0)+1;
      this.courts[cid]=[p1,p2];
    } else {
      let match=this.pickDoubles();
      if(!match){ this.courts[cid]=null; return; }
      let [t1,t2]=match;
      [t1,t2].forEach(team=>{
        team.forEach(p=>{p.matches++; p.last_played=this.round;});
        this.pair_count[[team[0].id,team[1].id].sort().join(',')] = (this.pair_count[[team[0].id,team[1].id].sort().join(',')]||0)+1;
      });
      this.vs_count[[ [t1[0].id,t1[1].id].sort().join(','), [t2[0].id,t2[1].id].sort().join(',') ].join('|')]=1;
      this.courts[cid]=[t1,t2];
    }
  }

  finishMatch(cid){
    this.courts[cid]=null;
    this.newMatch(cid);
  }

  addPlayer(){
    let new_id=Object.keys(this.players).length?Math.max(...Object.keys(this.players).map(x=>+x))+1:1;
    let min_matches=Object.values(this.players).length?Math.min(...Object.values(this.players).map(p=>p.matches)):0;
    let p=new Player(new_id); p.matches=min_matches;
    this.players[new_id]=p;
  }
}

let sched=null;

function renderCourts(){
  let container=document.getElementById("courts");
  container.innerHTML="";
  if(!sched) return;
  for(let i=0;i<sched.numCourts;i++){
    let div=document.createElement("div");
    div.className="court";
    div.dataset.cid=i;
    if(!sched.courts[i]) div.textContent=`Court ${i+1}: 空`;
    else if(sched.mode==='s'){
      let [p1,p2]=sched.courts[i];
      div.textContent=`Court ${i+1}: ${p1.id} vs ${p2.id}`;
    } else {
      let [t1,t2]=sched.courts[i];
      div.textContent=`Court ${i+1}: (${t1[0].id},${t1[1].id}) vs (${t2[0].id},${t2[1].id})`;
    }
    div.onclick=()=>{ sched.finishMatch(i); renderCourts(); };
    container.appendChild(div);
  }
}

// イベント設定
document.getElementById("numPlayers").oninput=function(){ document.getElementById("numPlayersVal").textContent=this.value; };
document.getElementById("numCourts").oninput=function(){ document.getElementById("numCourtsVal").textContent=this.value; };

document.getElementById("generate").onclick=function(){
  let numPlayers=parseInt(document.getElementById("numPlayers").value);
  let numCourts=parseInt(document.getElementById("numCourts").value);
  let mode=document.querySelector('input[name="mode"]:checked').value;
  sched=new Scheduler(numPlayers,numCourts,mode);
  for(let c=0;c<numCourts;c++) sched.newMatch(c);
  renderCourts();
};

document.getElementById("joinPlayer").onclick=function(){
  if(!sched) return;
  sched.addPlayer();
  for(let c=0;c<sched.numCourts;c++){
    if(!sched.courts[c]) sched.newMatch(c);
  }
  renderCourts();
};
</script>
</body>
</html>
