<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Badminton Scheduler</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f5f5f5; }
    .controls { margin: 20px; padding: 10px; background: #fff; border-radius: 10px; display: inline-block; }
    .courts { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
    .court { background: #fff; border: 2px solid #333; border-radius: 12px; width: 200px; height: 120px;
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
    .court h3 { margin: 0; font-size: 18px; }
    .court p { margin: 5px 0 0; font-size: 16px; }
    #log { margin-top: 15px; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>バドミントン試合スケジューラー</h1>

  <div class="controls">
    <div>
      <label>人数: <span id="numPlayersVal">4</span></label>
      <input type="range" id="numPlayers" min="2" max="20" value="4">
    </div>
    <div>
      <label>コート数: <span id="numCourtsVal">2</span></label>
      <input type="range" id="numCourts" min="1" max="5" value="2">
    </div>
    <div>
      <label><input type="radio" name="mode" value="s" checked> シングルス</label>
      <label><input type="radio" name="mode" value="d"> ダブルス</label>
    </div>
    <div>
      <button id="generate">試合生成</button>
      <button id="joinPlayer">プレイヤー追加</button>
      <button id="removePlayer">プレイヤー削除</button>
    </div>
    <div id="log"></div>
  </div>

  <div class="courts" id="courts"></div>

<script>
class Player {
  constructor(id) {
    this.id = id;
    this.matches = 0;
    this.lastPlayed = -1;
  }
}

class Scheduler {
  constructor(numPlayers, numCourts, mode) {
    this.players = {};
    for (let i = 1; i <= numPlayers; i++) {
      this.players[i] = new Player(i);
    }
    this.numCourts = numCourts;
    this.mode = mode; // "s" or "d"
    this.courts = Array(numCourts).fill(null);
    this.round = 0;
  }

  availablePlayers() {
    const busy = new Set();
    for (let m of this.courts) {
      if (!m) continue;
      if (this.mode === "s") {
        busy.add(m[0].id); busy.add(m[1].id);
      } else {
        for (let t of m) for (let p of t) busy.add(p.id);
      }
    }
    return Object.values(this.players).filter(p => !busy.has(p.id));
  }

  pickSingles() {
    let cand = this.availablePlayers();
    if (cand.length < 2) return null;
    cand.sort((a,b)=> a.matches-b.matches || a.lastPlayed-b.lastPlayed || a.id-b.id);
    let p1 = cand[0];
    cand = cand.slice(1);
    cand.sort((a,b)=> a.matches-b.matches || a.lastPlayed-b.lastPlayed || a.id-b.id);
    let p2 = cand[0];
    return [p1,p2];
  }

  pickDoubles() {
    let cand = this.availablePlayers();
    if (cand.length < 4) return null;
    let pairs=[];
    for(let i=0;i<cand.length;i++){
      for(let j=i+1;j<cand.length;j++){
        pairs.push([cand[i],cand[j]]);
      }
    }
    let team1=pairs[0], team2=null;
    outer: for(let t1 of pairs){
      for(let t2 of pairs){
        let ids=new Set([t1[0].id,t1[1].id,t2[0].id,t2[1].id]);
        if(ids.size===4){ team1=t1; team2=t2; break outer;}
      }
    }
    return [team1,team2];
  }

  newMatch(cid){
    this.round++;
    if(this.mode==="s"){
      let match=this.pickSingles();
      if(!match){ this.courts[cid]=null; return;}
      for(let p of match){ p.matches++; p.lastPlayed=this.round; }
      this.courts[cid]=match;
    } else {
      let match=this.pickDoubles();
      if(!match){ this.courts[cid]=null; return;}
      for(let team of match){ for(let p of team){ p.matches++; p.lastPlayed=this.round; } }
      this.courts[cid]=match;
    }
  }

  finishMatch(cid){ this.courts[cid]=null; this.newMatch(cid); }

  addPlayer(){
    let ids = Object.keys(this.players).map(x=>+x).sort((a,b)=>a-b);
    let newId=1;
    for(let i=0;i<ids.length;i++){ if(ids[i]!==i+1){ newId=i+1; break; } }
    if(newId===ids.length+1) newId=ids.length+1;
    let minMatches= ids.length? Math.min(...ids.map(id=>this.players[id].matches)) : 0;
    let p=new Player(newId);
    p.matches=minMatches;
    this.players[newId]=p;
    return newId;
  }

  removePlayer(pid){
    if(!(pid in this.players)) return false;
    for(let i=0;i<this.courts.length;i++){
      let m=this.courts[i];
      if(!m) continue;
      if(this.mode==="s"){
        if(m[0].id===pid || m[1].id===pid) this.courts[i]=null;
      } else {
        if(m[0][0].id===pid||m[0][1].id===pid||m[1][0].id===pid||m[1][1].id===pid) this.courts[i]=null;
      }
    }
    delete this.players[pid];
    return true;
  }
}

let sched=null;

function renderCourts(){
  const div=document.getElementById("courts");
  div.innerHTML="";
  for(let i=0;i<sched.numCourts;i++){
    const c=document.createElement("div");
    c.className="court";
    c.innerHTML=`<h3>コート${i+1}</h3>`;
    let m=sched.courts[i];
    if(!m){ c.innerHTML+=`<p>空き</p>`; }
    else if(sched.mode==="s"){ c.innerHTML+=`<p>${m[0].id} vs ${m[1].id}</p>`; }
    else { c.innerHTML+=`<p>(${m[0][0].id},${m[0][1].id}) vs (${m[1][0].id},${m[1][1].id})</p>`; }
    c.onclick=()=>{ sched.finishMatch(i); renderCourts(); };
    div.appendChild(c);
  }
}

// イベント
document.getElementById("numPlayers").oninput=function(){ document.getElementById("numPlayersVal").textContent=this.value; };
document.getElementById("numCourts").oninput=function(){ document.getElementById("numCourtsVal").textContent=this.value; };

document.getElementById("generate").onclick=function(){
  const numPlayers=+document.getElementById("numPlayers").value;
  const numCourts=+document.getElementById("numCourts").value;
  const mode=document.querySelector("input[name=mode]:checked").value;
  sched=new Scheduler(numPlayers,numCourts,mode);
  for(let c=0;c<numCourts;c++) sched.newMatch(c);
  renderCourts();
};

document.getElementById("joinPlayer").onclick=function(){
  if(!sched) return;
  const newId=sched.addPlayer();
  document.getElementById("numPlayers").value=Object.keys(sched.players).length;
  document.getElementById("numPlayersVal").textContent=Object.keys(sched.players).length;
  for(let c=0;c<sched.numCourts;c++){ if(!sched.courts[c]) sched.newMatch(c); }
  renderCourts();
  document.getElementById("log").textContent=`新しく ${newId} 番のプレイヤーが追加されました`;
};

document.getElementById("removePlayer").onclick=function(){
  if(!sched) return;
  let pid=prompt("削除するプレイヤー番号を入力してください:");
  if(!pid) return;
  pid=+pid;
  if(sched.removePlayer(pid)){
    document.getElementById("numPlayers").value=Object.keys(sched.players).length;
    document.getElementById("numPlayersVal").textContent=Object.keys(sched.players).length;
    for(let c=0;c<sched.numCourts;c++){ if(!sched.courts[c]) sched.newMatch(c); }
    renderCourts();
    document.getElementById("log").textContent=`プレイヤー ${pid} を削除しました`;
  } else {
    document.getElementById("log").textContent=`プレイヤー ${pid} は存在しません`;
  }
};
</script>
</body>
</html>
