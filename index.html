<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>🏸 バドミントン試合管理システム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls label {
      margin: 0 10px;
    }
    .controls button {
      font-size: 1.2em;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 8px;
    }
    .court {
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      margin: 10px;
      font-size: 1.5em;
      text-align: center;
      background: #f9f9f9;
    }
    .court-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 5px 10px;
      text-align: center;
    }
    .message {
      text-align: center;
      font-size: 1.2em;
      margin-top: 15px;
      color: blue;
    }
  </style>
</head>
<body>
  <h1>🏸 バドミントン試合管理システム</h1>

  <div class="controls">
    <label>人数: <span id="playerCountLabel">4</span></label>
    <input type="range" id="playerCount" min="2" max="20" value="4">
    
    <label>コート数: <span id="courtCountLabel">2</span></label>
    <input type="range" id="courtCount" min="1" max="10" value="2">

    <label>試合形式:</label>
    <select id="matchType">
      <option value="singles">シングルス</option>
      <option value="doubles">ダブルス</option>
    </select>

    <button id="generate">試合生成</button>
    <button id="addPlayer">プレイヤー追加</button>
    <button id="removePlayer">プレイヤー削除</button>
    <input type="number" id="removeId" placeholder="削除番号" min="1" style="width:80px;">
  </div>

  <h2>コート一覧</h2>
  <div class="court-container" id="courts"></div>

  <div class="table-container">
    <h2>プレイヤー番号表</h2>
    <table id="playerTable">
      <thead>
        <tr><th>番号</th><th>状態</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-container">
    <h2>番号管理表</h2>
    <table id="numberTable">
      <thead>
        <tr><th>使用中の番号</th><th>空席番号</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="message" id="message"></div>

  <script>
    let players = {};
    let availableIds = [];
    let nextId = 1;
    let matchHistory = []; // 試合ごとの履歴

    // プレイヤーデータ作成
    function createPlayer(id) {
      return {
        id: id,
        matches: 0,
        lastMatch: -1,
        opponents: {},
        partners: {}
      };
    }

    function updateTables() {
      // プレイヤー番号表
      const tbody = document.querySelector("#playerTable tbody");
      tbody.innerHTML = "";
      Object.keys(players).sort((a,b)=>a-b).forEach(id => {
        let row = document.createElement("tr");
        row.innerHTML = `<td>${id}</td><td>参加中</td>`;
        tbody.appendChild(row);
      });

      // 番号管理表
      const numBody = document.querySelector("#numberTable tbody");
      numBody.innerHTML = "";
      let used = Object.keys(players).sort((a,b)=>a-b).join(", ") || "-";
      let empty = availableIds.sort((a,b)=>a-b).join(", ") || "-";
      let row = document.createElement("tr");
      row.innerHTML = `<td>${used}</td><td>${empty}</td>`;
      numBody.appendChild(row);

      document.getElementById("playerCountLabel").innerText = Object.keys(players).length;
      document.getElementById("playerCount").value = Object.keys(players).length;
    }

    function addPlayer() {
      let id;
      if (availableIds.length > 0) {
        id = availableIds.shift();
      } else {
        id = nextId++;
      }
      players[id] = createPlayer(id);
      document.getElementById("message").innerText = `新しく ${id} 番のプレイヤーが追加されました`;
      updateTables();
    }

    function removePlayer() {
      const id = parseInt(document.getElementById("removeId").value);
      if (!id || !players[id]) {
        document.getElementById("message").innerText = `番号 ${id} のプレイヤーは存在しません`;
        return;
      }
      delete players[id];
      availableIds.push(id);
      document.getElementById("message").innerText = `${id} 番のプレイヤーが削除されました`;
      updateTables();
    }

    // 選手選出の基本ソート関数
    function sortPlayers(candidates) {
      return candidates.sort((a,b)=>{
        if (players[a].matches !== players[b].matches) {
          return players[a].matches - players[b].matches;
        }
        if (players[a].lastMatch !== players[b].lastMatch) {
          return players[a].lastMatch - players[b].lastMatch;
        }
        return a - b;
      });
    }

    // 試合生成
    function generateMatches() {
      Object.values(players).forEach(p => {
        p.matches = 0;
        p.lastMatch = -1;
        p.opponents = {};
        p.partners = {};
      });
      matchHistory = [];
      const courtCount = parseInt(document.getElementById("courtCount").value);
      const matchType = document.getElementById("matchType").value;
      const courtsDiv = document.getElementById("courts");
      courtsDiv.innerHTML = "";
      let ids = Object.keys(players).map(Number).sort((a,b)=>a-b);

      if (matchType === "singles") {
        for (let c=0; c<courtCount; c++) {
          if (ids.length < 2) break;
          let [p1, p2] = ids.splice(0,2);
          makeMatch([p1],[p2],c+1,courtsDiv);
        }
      } else {
        for (let c=0; c<courtCount; c++) {
          if (ids.length < 4) break;
          let [p1,p2,p3,p4] = ids.splice(0,4);
          makeMatch([p1,p2],[p3,p4],c+1,courtsDiv);
        }
      }
      updateTables();
    }

    function makeMatch(team1, team2, court, parent) {
      let div = document.createElement("div");
      div.className = "court";
      div.innerText = `コート${court}: ${team1.join("&")} vs ${team2.join("&")}`;
      parent.appendChild(div);

      let matchId = matchHistory.length;
      matchHistory.push({team1,team2});

      [...team1,...team2].forEach(pid=>{
        players[pid].matches++;
        players[pid].lastMatch = matchId;
      });
    }

    document.getElementById("addPlayer").addEventListener("click", addPlayer);
    document.getElementById("removePlayer").addEventListener("click", removePlayer);
    document.getElementById("generate").addEventListener("click", generateMatches);

    // 初期4人
    for (let i=0;i<4;i++) addPlayer();
  </script>
</body>
</html>
